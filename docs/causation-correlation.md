# Causation and Correlation in go-crablet

go-crablet automatically tracks **causation** and **correlation** to help you understand the relationships between events in your system. This is essential for debugging, auditing, and understanding event flows.

## Understanding the Concepts

- **Causation ID**: Links events that are directly caused by each other (automatically generated by the append implementation)
- **Correlation ID**: Groups related events that are part of the same logical operation (automatically generated by the append implementation)

## How It Works

When you append multiple events in a single batch, go-crablet automatically:

1. **Generates event IDs** based on the event tags (using TypeID format)
2. **Sets correlation ID** to the first event's ID in the batch
3. **Chains causation IDs** so each event points to the previous event in the batch

## Implementation Details: TypeID-Based Generation

Our implementation uses **TypeID** to generate unique, sortable event identifiers based on event tags. Here's how it works:

### Event ID Generation

Each event gets a unique ID generated from its tags:

```go
// Event with tags: {"account_id": "alice"}
// Generated ID: alice_01h2xcejqtf2nbrexx3vqjhp41

// Event with tags: {"from_account": "alice", "to_account": "bob"}
// Generated ID: alice_bob_01h2xcejqtf2nbrexx3vqjhp42
```

**TypeID Format:**
- **Prefix**: Sorted tag keys joined with underscores (e.g., `alice`, `alice_bob`)
- **UUID**: 26-character TypeID suffix (e.g., `01h2xcejqtf2nbrexx3vqjhp41`)
- **Total**: Maximum 64 characters to fit in database VARCHAR(64)

### Causation and Correlation Logic

For a batch of events, the implementation:

```go
// Batch: [event1, event2, event3]

// Event 1: First in batch
event1.ID = "alice_01h2xcejqtf2nbrexx3vqjhp41"
event1.CausationID = event1.ID      // Self-caused (first event)
event1.CorrelationID = event1.ID    // Root of correlation chain

// Event 2: Second in batch  
event2.ID = "bob_01h2xcejqtf2nbrexx3vqjhp42"
event2.CausationID = event1.ID      // Caused by previous event
event2.CorrelationID = event1.ID    // Same correlation as first event

// Event 3: Third in batch
event3.ID = "alice_bob_01h2xcejqtf2nbrexx3vqjhp43"
event3.CausationID = event2.ID      // Caused by previous event
event3.CorrelationID = event1.ID    // Same correlation as first event
```

**Key Rules:**
- **Correlation ID**: Always the first event's ID in the batch (groups all related events)
- **Causation ID**: Points to the previous event's ID (creates a chain of causation)
- **First Event**: Both causation and correlation IDs are the same as its own ID

### Tag-Based Consistency

The TypeID generation ensures consistency:

```go
// Same tags always generate same prefix (UUID part varies)
tags1 := []Tag{{Key: "account_id", Value: "alice"}}
tags2 := []Tag{{Key: "account_id", Value: "alice"}}

// Both generate: alice_<different_uuid>
// But prefix "alice" is always the same
```

This allows you to:
- **Query by tag patterns** using the TypeID prefix
- **Group related events** by their tag-based IDs
- **Maintain consistency** across different event instances

## Code Example

For a complete working example of causation and correlation in the Account domain, see:

**[Transfer Example](examples/transfer/main.go)**: Complete implementation showing AccountOpened and MoneyTransferred events with automatic causation and correlation IDs.

### Key Concepts in the Example:

```go
// Create events for a money transfer operation
event1 := dcb.NewInputEvent("AccountOpened", dcb.NewTags("account_id", "alice"), data1)
event2 := dcb.NewInputEvent("AccountOpened", dcb.NewTags("account_id", "bob"), data2)
event3 := dcb.NewInputEvent("MoneyTransferred", dcb.NewTags("from_account", "alice", "to_account", "bob"), data3)

// Append all events - causation and correlation IDs are generated automatically
store.Append(ctx, []dcb.InputEvent{event1, event2, event3}, nil)
```

**What happens internally:**
- Event 1 gets ID: `alice_01h2xcejqtf2nbrexx3vqjhp41` (correlation ID = same, causation ID = same)
- Event 2 gets ID: `bob_01h2xcejqtf2nbrexx3vqjhp42` (correlation ID = Event 1's ID, causation ID = Event 1's ID)
- Event 3 gets ID: `alice_bob_01h2xcejqtf2nbrexx3vqjhp43` (correlation ID = Event 1's ID, causation ID = Event 2's ID)

**Event Types Used:**
- `AccountOpened`: When an account is created with initial balance and owner
- `MoneyTransferred`: When money is transferred between accounts (includes final balances)

## Reading Events with Causation/Correlation

```go
// Read events and examine their relationships
events, err := store.Read(ctx, query, nil)
if err != nil {
    log.Fatal(err)
}

for _, event := range events.Events {
    fmt.Printf("Event: %s (Position: %d)\n", event.Type, event.Position)
    fmt.Printf("  Causation ID: %s\n", event.CausationID)
    fmt.Printf("  Correlation ID: %s\n", event.CorrelationID)
    fmt.Printf("  Event ID: %s\n", event.ID)
    fmt.Println()
}
```

## Benefits

- **Debugging**: Trace exactly which event caused another
- **Auditing**: Group related events for compliance and reporting
- **Replay**: Understand the complete flow of operations
- **Monitoring**: Track performance and identify bottlenecks in event chains

## Best Practices

1. **Append related events in the same batch** to ensure they share the same correlation ID
2. **Order events logically** within the batch to create meaningful causation chains
3. **Use descriptive tags** that will generate meaningful event IDs
4. **Keep batches focused** on a single logical operation

## Account Domain Event Types

**Core Account Events:**
- `AccountOpened`: When an account is created with initial balance and owner
- `MoneyTransferred`: When money is transferred between accounts (includes final balances)

**Event Flow:**
1. **AccountOpened**: Creates accounts for Alice and Bob
2. **MoneyTransferred**: Transfers money between accounts with updated balances

All events in the same batch automatically share the same correlation ID and are chained by causation IDs to show the logical flow of the account operations. 