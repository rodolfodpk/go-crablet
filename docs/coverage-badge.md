# Code Coverage Badge

This document explains how the custom code coverage badge works and how it's integrated into the CI pipeline.

## 🏷️ **Custom Coverage Badge**

The project uses a custom code coverage badge that shows the current test coverage percentage for the core go-crablet library (`pkg/dcb`).

### **Badge Features**

- **Dynamic Coverage**: Updates automatically with each CI run
- **Color Coding**: Changes color based on coverage percentage
- **Go Logo**: Includes the Go programming language logo
- **Clickable**: Links to the coverage workflow for details

### **Color Scheme**

| Coverage | Color | Status |
|----------|-------|---------|
| 90%+ | 🟢 Bright Green | Excellent |
| 80-89% | 🟢 Green | Good |
| 70-79% | 🟡 Yellow Green | Fair |
| 60-69% | 🟡 Yellow | Needs Improvement |
| 50-59% | 🟠 Orange | Poor |
| <50% | 🔴 Red | Critical |

## 🔧 **How It Works**

### **GitHub Actions Workflow**

The badge is generated by the `.github/workflows/coverage.yml` workflow:

1. **Runs Tests**: Executes all tests in the `pkg/dcb` package
2. **Generates Coverage**: Creates coverage report using `go test -coverprofile`
3. **Extracts Percentage**: Parses the coverage percentage from the report
4. **Updates Badge**: Replaces the existing badge in README.md
5. **Commits Changes**: Automatically commits the updated badge

### **Workflow Triggers**

- **Push to main**: Updates badge on every push
- **Pull Requests**: Shows coverage for PR changes
- **Manual Trigger**: Can be run manually via GitHub Actions

### **Badge Format**

```markdown
[![Code Coverage](https://img.shields.io/badge/code%20coverage-86.7%25-green?logo=go)](https://github.com/rodolfodpk/go-crablet/actions/workflows/coverage.yml)
```

- **Label**: "code coverage"
- **Message**: Current percentage (e.g., "86.7%")
- **Color**: Dynamic based on coverage level
- **Logo**: Go programming language logo
- **Link**: Points to the coverage workflow

## 📊 **Coverage Calculation**

### **What's Included**

- **Core Library**: Only `pkg/dcb` package coverage
- **Unit Tests**: All test functions and methods
- **Integration Tests**: Database interaction tests
- **Error Handling**: Exception and edge case tests

### **What's Excluded**

- **Examples**: `internal/examples/` directory
- **Benchmarks**: `internal/benchmarks/` directory
- **Documentation**: `docs/` directory
- **CLI Tools**: `cmd/` directory

### **Coverage Command**

```bash
go test -coverprofile=coverage.out ./pkg/dcb
go tool cover -func=coverage.out
```

## 🚀 **Setup and Configuration**

### **Prerequisites**

1. **GitHub Repository**: Must be a GitHub repository
2. **GitHub Actions**: Enabled for the repository
3. **PostgreSQL**: Required for tests (provided by workflow)

### **Workflow Configuration**

The workflow automatically:
- Sets up Go 1.24
- Starts PostgreSQL service
- Runs tests with coverage
- Updates the badge
- Commits changes

### **Environment Variables**

```yaml
POSTGRES_HOST: localhost
POSTGRES_PORT: 5432
POSTGRES_USER: postgres
POSTGRES_PASSWORD: postgres
POSTGRES_DB: testdb
```

## 🔍 **Monitoring and Alerts**

### **Coverage Thresholds**

- **Warning**: Below 80% coverage
- **Critical**: Below 70% coverage
- **Target**: 90%+ coverage

### **Workflow Artifacts**

The workflow generates:
- **Coverage Report**: `coverage.out` file
- **HTML Report**: `coverage.html` for detailed analysis
- **Badge Update**: Automatic README.md update

### **Accessing Reports**

1. **GitHub Actions**: Go to Actions tab → Coverage workflow
2. **Artifacts**: Download coverage reports from workflow runs
3. **Badge**: Click the badge in README for workflow details

## 🛠️ **Customization**

### **Modifying Colors**

Edit the color logic in `.github/workflows/coverage.yml`:

```bash
if [ "$COVERAGE" -ge 90 ]; then
  COLOR="brightgreen"
elif [ "$COVERAGE" -ge 80 ]; then
  COLOR="green"
# ... add more conditions
fi
```

### **Changing Badge Style**

Modify the badge URL format:

```bash
NEW_BADGE="[![Code Coverage](https://img.shields.io/badge/code%20coverage-${COVERAGE}%25-${COLOR}?logo=go&style=flat)](https://github.com/rodolfodpk/go-crablet/actions/workflows/coverage.yml)"
```

### **Adding More Metrics**

Extend the workflow to include:
- **Test Count**: Number of tests run
- **Duration**: Test execution time
- **Memory Usage**: Memory consumption during tests

## 📈 **Benefits**

### **For Developers**

- **Quick Overview**: See coverage at a glance
- **Trend Tracking**: Monitor coverage over time
- **Quality Assurance**: Ensure adequate test coverage
- **Visual Feedback**: Color-coded status indicators

### **For Contributors**

- **Transparency**: Clear visibility into test quality
- **Standards**: Understand coverage expectations
- **Motivation**: Visual incentive to maintain high coverage
- **Guidance**: Know which areas need more testing

### **For Maintainers**

- **Automation**: No manual badge updates required
- **Consistency**: Uniform coverage reporting
- **Monitoring**: Easy tracking of coverage trends
- **Quality Control**: Automated coverage enforcement

## 🔗 **Integration with Other Tools**

### **Shields.io**

The badge uses shields.io for rendering:
- **Reliable**: High availability and performance
- **Customizable**: Various styles and options
- **Standard**: Widely used across open source projects

### **GitHub Actions**

Seamless integration with:
- **CI/CD Pipeline**: Automated testing and reporting
- **Pull Requests**: Coverage checks on PRs
- **Repository Settings**: Easy configuration and monitoring

---

## 📝 **Conclusion**

The custom code coverage badge provides:
- **Real-time coverage updates** with every CI run
- **Visual quality indicators** with color coding
- **Automated maintenance** requiring no manual intervention
- **Professional presentation** suitable for open source projects

This system ensures that coverage information is always current and easily accessible to all project stakeholders. 